<?php
use Symfony\Component\ClassLoader\ApcClassLoader;

/**
 * Implements hook_boot().
 */
function classloader_composer_boot() {
  classloader_composer_register();
}

/**
 * Implements hook_init().
 */
function classloader_composer_init() {
  classloader_composer_register();
}

/**
 * Implements hook_modules_installed().
 */
function classloader_composer_modules_installed(array $modules) {
  classloader_composer_register();
}

/**
 * Implements hook_modules_enabled().
 */
function classloader_composer_modules_enabled(array $modules) {
  classloader_composer_register();
}

/**
 * Registers namespaced generated by composer
 *
 * @throws RuntimeException if composer autoloading file cannot be found
 */
function classloader_composer_register() {
  static $registered = false;

  if (!$registered) {
    $autoload_file = DRUPAL_ROOT . '/../vendor/autoload.php';
    if (!file_exists($autoload_file)) {
      throw new \RuntimeException('Composer autoload file not found: ' . $autoload_file);
    }

    $loader = require $autoload_file;
    if (function_exists('apc_exists')) {
      $cachedLoader  = new ApcClassLoader('drupal', $loader);
      $cachedLoader->register();
      $loader->unregister();
    }

    $registered = true;
  }
}
